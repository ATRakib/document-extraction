<p-toast />
<p-confirmDialog />

<div class="upload-container">
    <!-- Upload Section -->
    <p-card styleClass="upload-card">
        <ng-template pTemplate="header">
            <div class="card-header">
                <i class="pi pi-cloud-upload"></i>
                <span>Document Upload & Extraction</span>
            </div>
        </ng-template>

        <p-message 
    *ngIf="isDuplicate" 
    severity="warn" 
    styleClass="mb-4 w-full block">

    
        <div class="flex items-center gap-2">
            <i class="pi pi-exclamation-triangle text-xl"></i>
            <span>
                <strong>Duplicate File Detected:</strong> 
                This file has already been processed. 
                You can preview the data but cannot save it again.
            </span>
        </div>
    
</p-message>




        <div class="grid">
            <div class="col-12 md:col-6">
                <label class="input-label">
                    <i class="pi pi-file"></i>
                    Select File (PDF, Word, Excel)
                </label>
                <div class="file-input-wrapper">
                    <input 
                        type="file" 
                        (change)="onFileSelect($event)" 
                        accept=".pdf,.doc,.docx,.xls,.xlsx" 
                        class="file-input"
                        id="fileInput">
                    <label for="fileInput" class="file-input-label">
                        <i class="pi pi-upload"></i>
                        <span>{{ selectedFile ? selectedFile.name : 'Choose a file' }}</span>
                    </label>
                </div>
            </div>

            <div class="col-12 md:col-6">
                <label class="input-label">
                    <i class="pi pi-key"></i>
                    Keywords (optional)
                </label>
                <input 
                    type="text" 
                    pInputText 
                    [(ngModel)]="keywords" 
                    placeholder="e.g., model, price, specifications" 
                    class="w-full" />
            </div>

            <div class="col-12">
                <p-button 
                    label="Extract & Preview" 
                    icon="pi pi-search" 
                    (onClick)="extractDocument()" 
                    [disabled]="!selectedFile"
                    styleClass="extract-button" />
            </div>
        </div>
    </p-card>

    <!-- Extracted Products Section -->
    <div *ngIf="extractedProducts.length > 0" class="extracted-section">
        <p-card styleClass="results-card">
            <ng-template pTemplate="header">
                <div class="card-header">
                    <i class="pi pi-box"></i>
                    <span>Extracted Products ({{ extractedProducts.length }})</span>
                </div>
            </ng-template>

            <div *ngFor="let product of extractedProducts; let i = index" class="product-container mb-4">
                <!-- Product Master Section -->
                <p-card styleClass="form-card product-master-section">
                    <ng-template pTemplate="header">
                        <div class="section-header master-header section-title">
                            <i class="pi pi-shopping-cart"></i>
                            <span>Product Master #{{ i + 1 }}</span>
                            <div class="ml-auto">
                                <p-button 
                                    label="Add Spec" 
                                    icon="pi pi-plus" 
                                    [outlined]="true"
                                    size="small"
                                    color="white"
                                    severity="success"
                                    (onClick)="addSpecification(i)" />
                            </div>
                        </div>
                    </ng-template>

                    <div class="grid grid-cols-12 gap-4">

                        <div class="col-span-4">
                            <label class="input-label">Model Name</label>
                            <input 
                                type="text" 
                                pInputText 
                                [(ngModel)]="product.master.ModelName"
                                placeholder="Enter model name"
                                class="w-full" />
                        </div>

                        <div class="col-span-4">
                            <label class="input-label">Price</label>
                            <p-inputnumber 
                                [(ngModel)]="product.master.ProductPrice"
                                mode="currency" 
                                currency="USD"
                                placeholder="0.00"
                                class="w-full" />
                        </div>

                        <div class="col-span-4">
                            <label class="input-label">Country</label>
                            <input 
                                type="text" 
                                pInputText 
                                [(ngModel)]="product.master.CountryOfOrigin"
                                placeholder="e.g., USA, China"
                                class="w-full" />
                        </div>

                        <div class="col-span-7">
                            <label class="input-label">
                                Supplier
                                <span *ngIf="!product.master.SupplierId" class="text-red-500">*</span>
                            </label>
                            <div class="flex items-start gap-2">
                                <div class="flex-1">
                                    <p-autoComplete 
                                        [(ngModel)]="product.extractedSupplierName"
                                        [suggestions]="filteredSuppliers"
                                        (completeMethod)="searchSupplier($event, i)"
                                        (onSelect)="onSupplierSelect($event, i)"
                                        (ngModelChange)="onSupplierChange(i)"
                                        optionLabel="Name"
                                        [dropdown]="true"
                                        [forceSelection]="false"
                                        placeholder="Select or type supplier name"
                                        styleClass="w-full">
                                    </p-autoComplete>
                                    
                                    <!-- Show message when supplier is not in database -->
                                    <div *ngIf="product.isNewSupplier && product.extractedSupplierName" 
                                         class="text-orange-600 text-sm mt-1 flex items-center gap-1">
                                        <i class="pi pi-info-circle"></i>
                                        <span>এই Supplier database-এ নেই: <strong>{{ product.extractedSupplierName }}</strong></span>
                                    </div>
                                </div>

                                <div class="flex items-center gap-2">
                                     <p-tag 
                                        *ngIf="!product.isNewSupplier && product.master.SupplierId"
                                        value="✓"
                                        severity="success"
                                        [rounded]="true"
                                        pTooltip="Supplier assigned" />
                                    <!-- Create Supplier Button - shows when supplier is new -->
                                    <p-button 
                                        label="Create"
                                        icon="pi pi-plus"
                                        severity="success"
                                        [outlined]="true"
                                        size="small"
                                        (onClick)="openAddSupplierDialog(i, product.extractedSupplierName || '')"
                                        pTooltip="Create this supplier" />

                                    <!-- Success indicator - shows when supplier is selected -->
                                   
                                </div>
                            </div>
                        </div>

                        <div class="col-span-5">
                            <label class="input-label">Quotation</label>
                            <input 
                                type="text" 
                                pInputText 
                                [(ngModel)]="product.master.Quotation"
                                placeholder="Quotation ref"
                                class="w-full" />
                        </div>

                        <div class="col-span-12">
                            <label class="input-label">Description</label>
                            <textarea 
                                pTextarea 
                                [(ngModel)]="product.master.Description"
                                rows="2"
                                placeholder="Description..."
                                class="w-full"></textarea>
                        </div>

                    </div>

                </p-card>

                <!-- Product Specifications Section -->
                <div class="product-specs-section">
                    <div class="section-title">
                        <div class="title-left">
                            <i class="pi pi-list"></i>
                            <span>Specifications ({{ product.specifications.length }})</span>
                        </div>
                    </div>
                    
                    <div *ngIf="product.specifications.length === 0" class="empty-specs">
                        <i class="pi pi-inbox"></i>
                        <p>No specifications added</p>
                    </div>

                    <p-table 
                        *ngIf="product.specifications.length > 0"
                        [value]="product.specifications" 
                        styleClass="specs-table">
                        <ng-template pTemplate="header">
                            <tr>
                                <th style="width: 50px">#</th>
                                <th>Specification Name</th>
                                <th>Size</th>
                                <th>Price</th>
                                <th>Other Terms</th>
                                <th style="width: 80px">Action</th>
                            </tr>
                        </ng-template>
                        <ng-template pTemplate="body" let-spec let-rowIndex="rowIndex">
                            <tr>
                                <td>
                                    <p-tag [value]="(rowIndex + 1).toString()" severity="info"></p-tag>
                                </td>
                                <td>
                                    <input 
                                        type="text" 
                                        pInputText 
                                        [(ngModel)]="spec.SpecificationName"
                                        placeholder="Specification name"
                                        class="w-full table-input" />
                                </td>
                                <td>
                                    <input 
                                        type="text" 
                                        pInputText 
                                        [(ngModel)]="spec.Size"
                                        placeholder="Size"
                                        class="w-full table-input" />
                                </td>
                                <td>
                                    <p-inputnumber 
                                        [(ngModel)]="spec.ProductSpecificationPrice"
                                        mode="currency" 
                                        currency="USD"
                                        class="w-full" />
                                </td>
                                <td>
                                    <input 
                                        type="text" 
                                        pInputText 
                                        [(ngModel)]="spec.OtherTerms"
                                        placeholder="Other terms"
                                        class="w-full table-input" />
                                </td>
                                <td>
                                    <p-button 
                                        icon="pi pi-trash" 
                                        [text]="true" 
                                        [rounded]="true"
                                        severity="danger"
                                        (onClick)="deleteSpecification(i, rowIndex)"
                                        pTooltip="Delete" />
                                </td>
                            </tr>
                        </ng-template>
                    </p-table>
                </div>

                <p-divider *ngIf="i < extractedProducts.length - 1"></p-divider>
            </div>

            <ng-template pTemplate="footer">
                <div class="flex justify-content-end">
                    <p-button 
                        label="Save All Products" 
                        icon="pi pi-save" 
                        severity="success" 
                        (onClick)="saveAll()" 
                        [disabled]="isDuplicate"
                        size="large" />
                </div>
            </ng-template>
        </p-card>
    </div>
</div>

<!-- Add Supplier Dialog -->
<p-dialog 
    [(visible)]="addSupplierDialog" 
    [style]="{width: '500px'}" 
    header="Add New Supplier" 
    [modal]="true"
    styleClass="supplier-dialog">
    
    <div class="grid">
        <div class="col-span-5">
            <label class="field-label required">Supplier Name</label>
            <input 
                type="text" 
                pInputText 
                [(ngModel)]="newSupplierName"
                placeholder="Enter supplier name"
                class="w-full" />
        </div>
        
        <div class="col-span-5">
            <label class="field-label">Email</label>
            <input 
                type="email" 
                pInputText 
                [(ngModel)]="newSupplierEmail"
                placeholder="supplier@example.com"
                class="w-full" />
        </div>
        
        <div class="col-span-5">
            <label class="field-label">Phone</label>
            <input 
                type="text" 
                pInputText 
                [(ngModel)]="newSupplierPhone"
                placeholder="+1234567890"
                class="w-full" />
        </div>
        
        <div class="col-span-5">
            <label class="field-label">Address</label>
            <textarea 
                pTextarea 
                [(ngModel)]="newSupplierAddress"
                rows="3"
                placeholder="Enter supplier address"
                class="w-full"></textarea>
        </div>
    </div>

    <ng-template pTemplate="footer">
        <p-button 
            label="Cancel" 
            icon="pi pi-times" 
            [outlined]="true"
            (click)="addSupplierDialog = false" />
        <p-button 
            label="Save Supplier" 
            icon="pi pi-check" 
            severity="success"
            (click)="saveNewSupplier()" />
    </ng-template>
</p-dialog>